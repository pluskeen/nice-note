
![[TCP连接.png]]


##### 三次握手

第一次握手：建立连接。客户端发送连接请求报文段，将 SYN 位置为1，Sequence Number 为 x，然后，客户端进入 SYN_SEND 状态，等待服务器的确认。
大白话：客户端对服务端说：“喂！服务端，你听得到我说话吗？”

第二次握手：服务器收到 SYN 报文段。服务器收到客户端的 SYN 报文段，需要对这个 SYN 报文段进行确认，设置 Acknowledgment Number 为 x+1(Sequence Number+1)，同时，自己还要发送SYN 请求信息，将 SYN 位置为 1，Sequence Number 为 y。服务器端将上述所有信息放到一个报文段（即 SYN + ACK 报文段）中，一并发送给客户端，此时服务器进入 SYN_RECV状态。
大白话：服务端听到了客户端的话，并回应：“听得到！你能听到我说话吗？”

第三次握手：客户端收到服务器的 SYN + ACK 报文段。然后将 Acknowledgment Number 设置为 y+1，向服务器发送 ACK 报文段，这个报文段发送完毕以后，客户端和服务器端都进入ESTABLISHED 状态，完成 TC 三次握手。
大白话：客户端听到了服务端的回应，再次对服务端说：“我也能听到你说话，我们可以说话啦！”

为了保证服务端能收接受到客户端的信息并能做出正确的应答而进行前两次(第一次和第二次)握手，为了保证客户端能够接收到服务端的信息并能做出正确的应答而进行后两次(第二次和第三次)握手。

为什么要进行第三次握手：防止服务端一直等待客户端的信息，而浪费自己的时间。如果只采用二次握手，服务端就会认为客户端是想传输数据，进而一直等待。增加第三次握手机制，服务端等待一会后发现客户端没有回应，就会断开连接。三次握手也是为了满足证明信道可靠的最小值，如果信道可靠，那后续发送消息，对方也一定能收到。


##### 四次分手

客户端和服务器通过三次握手建立了 TCP 连接以后，当数据传送完毕，肯定要断开 TCP 连接，那对于 TCP 的断开连接，就有了四次分手。

第一次分手：A（可以使客户端，也可以是服务器端），设置 Sequence Number 和Acknowledgment Number，向 B 发送一个 FIN 报文段；此时，A 进入 FIN_WAIT_1 状态；这表示 A没有数据要发送给 B 了。
大白话：A 对 B 说：“我没有话要跟你说了，想离开了。”

第二次分手：B 收到了 A 发送的 FIN 报文段，向 A 回一个 ACK 报文段，Acknowledgment Number为 Sequence Number 加 1； A 进入 FIN_WAIT_2 状态；B 告诉 A，我“同意”你的关闭请求。
大白话：B 听到了 A 的话，并立马回应：“我知道你想走了，也同意你离开，但是我还有些话没说完，请等我说完。”

第三次分手：B 向 A 发送 FIN 报文段，请求关闭连接，同时 B 进入 LAST_ACK 状态；
大白话：B 的话说完后，跟 A 说：“我话说完了，也要离开了。”

第四次分手：A 收到 B 发送的 FIN 报文段，向 B 发送 ACK 报文段，然后 A 进入 TIME_WAIT 状态；B 收到 A 的 ACK 报文段以后，就关闭连接；此时，A 等待 2MSL 后依然没有收到回复，则证明Server 端已正常关闭，那好，A 也可以关闭连接了。
大白话：A 听到 B 想离开的意图后，回应到：“好的，你走吧。”，B 听完，就离开了。A 看 B 走了，礼貌的等待了一会，也是怕 B 可能还有话要说，见没有回应，就知道 B 真走了，也就离开了。